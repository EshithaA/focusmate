<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusMate - Pomodoro Timer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Global Reset and Base Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 20px;
        }

        /* Container (Glassmorphism Effect) */
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            z-index: -1;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-level {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .back-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .back-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        /* Timer Display */
        .timer-display {
            font-size: 4rem;
            font-weight: bold;
            margin: 30px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 2px;
        }

        /* Mode Display */
        .mode-display {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .study-mode {
            background: rgba(46, 204, 113, 0.3);
            border: 2px solid #2ecc71;
        }

        .break-mode {
            background: rgba(231, 76, 60, 0.3);
            border: 2px solid #e74c3c;
        }

        /* Controls and Buttons */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .start-btn {
            background: #2ecc71;
            color: white;
        }

        .start-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .pause-btn {
            background: #f39c12;
            color: white;
        }

        .pause-btn:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .reset-btn {
            background: #e74c3c;
            color: white;
        }

        .reset-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Settings Section */
        .settings {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .settings h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-field {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .input-field label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .input-field input {
            width: 80px;
            padding: 8px;
            border: none;
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            border-radius: 4px;
            /* Smoother progress update */
            transition: width 1s linear;
            width: 0%;
        }

        .break-mode .progress-fill {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        /* Break Notification */
        .break-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            display: none;
            border: 2px solid #e74c3c;
            max-width: 90%;
            width: 400px;
        }

        .break-notification h3 {
            color: #e74c3c;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .break-notification p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .break-notification button {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .break-notification button:hover {
            background: #45b7b8;
            transform: translateY(-2px);
        }

        /* --- Break Cap Notification Styles --- */
        .break-cap-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            display: none; 
            border: 2px solid #f39c12; /* Warning color (orange) */
            max-width: 90%;
            width: 400px;
        }

        .break-cap-notification h3 {
            color: #f39c12;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .break-cap-notification p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .break-cap-notification button {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .break-cap-notification button:hover {
            background: #45b7b8;
            transform: translateY(-2px);
        }
        /* XP and Level Up Notifications */
        .xp-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(46, 204, 113, 0.95);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            display: none;
            border: 2px solid #2ecc71;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .xp-notification h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .xp-notification .xp-amount {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .level-up-notification {
            background: rgba(241, 196, 15, 0.95);
            border: 2px solid #f1c40f;
        }

        .level-up-notification h3 {
            color: #f39c12;
        }

        /* Stats Section */
        .stats {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stats h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            text-align: center;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 5px 0;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            .timer-display {
                font-size: 3rem;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            button {
                width: 200px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Footer */
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-clock"></i> FocusMate</h1>
        
        <div class="user-info">
            <div class="user-level" id="userLevel">
                <i class="fas fa-star"></i> <span id="userRank">Loading...</span>
            </div>
            <button class="back-btn" id="backBtn">
                <i class="fas fa-arrow-left"></i> Dashboard
            </button>
        </div>

        <div class="mode-display study-mode" id="modeDisplay">Study Time</div>

        <div class="timer-display" id="timerDisplay">25:00</div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="controls">
            <button class="start-btn" id="startBtn">
                <i class="fas fa-play"></i> Start
            </button>
            <button class="pause-btn" id="pauseBtn" style="display: none">
                <i class="fas fa-pause"></i> Pause
            </button>
            <button class="reset-btn" id="resetBtn">
                <i class="fas fa-redo"></i> Reset
            </button>
        </div>

        <div class="settings">
            <h3><i class="fas fa-cog"></i> Customize Your Timer</h3>

            <div class="input-group">
                <div class="input-field">
                    <label for="studyMinutes">Study (minutes)</label>
                    <input
                        type="number"
                        id="studyMinutes"
                        value="25"
                        min="1"
                        max="120"
                    />
                </div>
                <div class="input-field">
                    <label for="breakMinutes">Break (minutes)</label>
                    <input type="number" id="breakMinutes" value="5" min="1" max="60" />
                </div>
            </div>

            <div class="preset-buttons">
                <button class="preset-btn">25-5</button>
                <button class="preset-btn">45-5</button>
                <button class="preset-btn">50-10</button>
                <button class="preset-btn">60-10</button>
            </div>
        </div>

        <div class="stats">
            <h3><i class="fas fa-chart-line"></i> Session Stats</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="studyCount">0</div>
                    <div class="stat-label">Study Sessions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="breakCount">0</div>
                    <div class="stat-label">Breaks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalTime">0</div>
                    <div class="stat-label">Total Time</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="productivity">0%</div>
                    <div class="stat-label">Productivity</div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Stay focused, stay productive!</p>
        </div>
    </div>

    <div class="break-notification" id="breakNotification">
        <h3><i class="fas fa-coffee"></i> Break Time!</h3>
        <p>Time to relax and recharge.</p>
        <button id="closeBreakNotificationBtn">
            <i class="fas fa-check"></i> Okay
        </button>
    </div>

    <div class="break-cap-notification" id="breakCapNotification">
        <h3><i class="fas fa-exclamation-triangle"></i> Break Time Capped</h3>
        <p>
            Your break time must be *less than* your Study Time.
            <br />
            The maximum break allowed is now:
            <strong id="cappedBreakTime">24</strong> minutes.
        </p>
        <button id="closeBreakCapBtn">
            <i class="fas fa-check"></i> Got It
        </button>
    </div>

    <div class="xp-notification" id="xpNotification">
        <h3><i class="fas fa-star"></i> Focus Points Earned!</h3>
        <div class="xp-amount" id="xpAmount">+25 XP</div>
        <p id="xpReason">Completed Pomodoro Session</p>
        <button id="closeXpBtn">
            <i class="fas fa-check"></i> Awesome!
        </button>
    </div>

    <script type="module">
        import { auth, getUserData, updateUserData, addXP, onAuthStateChange } from './firebase-config-demo.js';

        class PomodoroTimer {
            constructor() {
                this.isRunning = false;
                this.isPaused = false;
                this.isStudyMode = true;
                this.timeLeft = 0;
                this.totalTime = 0;
                this.interval = null;
                this.studyCount = 0;
                this.breakCount = 0;
                this.totalTimeSpent = 0;
                this.currentUser = null;
                this.userData = null;

                // DOM Elements
                this.timerDisplay = document.getElementById("timerDisplay");
                this.modeDisplay = document.getElementById("modeDisplay");
                this.progressFill = document.getElementById("progressFill");
                this.startBtn = document.getElementById("startBtn");
                this.pauseBtn = document.getElementById("pauseBtn");
                this.resetBtn = document.getElementById("resetBtn");
                this.studyInput = document.getElementById("studyMinutes");
                this.breakInput = document.getElementById("breakMinutes");
                
                this.breakNotification = document.getElementById("breakNotification");
                this.breakCapNotification = document.getElementById("breakCapNotification");
                this.cappedBreakTimeDisplay = document.getElementById("cappedBreakTime");
                this.xpNotification = document.getElementById("xpNotification");
                this.xpAmount = document.getElementById("xpAmount");
                this.xpReason = document.getElementById("xpReason");
                
                // Stats elements
                this.studyCountElement = document.getElementById("studyCount");
                this.breakCountElement = document.getElementById("breakCount");
                this.totalTimeElement = document.getElementById("totalTime");
                this.productivityElement = document.getElementById("productivity");

                // User info elements
                this.userRank = document.getElementById("userRank");
                this.backBtn = document.getElementById("backBtn");

                this.setupEventListeners();
                this.initializeAuth();
                // Initialize state based on input fields
                this.updateSettings(true);
                this.toggleSettings(true); // Ensure inputs are enabled initially
                this.updateStats();
            }

            async initializeAuth() {
                onAuthStateChange(async (user) => {
                    if (user) {
                        this.currentUser = user;
                        await this.loadUserData();
                    } else {
                        window.location.href = 'login.html';
                    }
                });
            }

            async loadUserData() {
                if (!this.currentUser) return;

                const result = await getUserData(this.currentUser.uid);
                if (result.success) {
                    this.userData = result.data;
                    this.userRank.textContent = `${this.userData.rank} (Level ${this.userData.level})`;
                    this.studyCount = this.userData.studySessions || 0;
                    this.breakCount = this.userData.totalBreakTime || 0;
                    this.totalTimeSpent = this.userData.totalStudyTime || 0;
                    this.updateStats();
                }
            }

            setupEventListeners() {
                this.startBtn.addEventListener("click", () => this.start());
                this.pauseBtn.addEventListener("click", () => this.pause());
                this.resetBtn.addEventListener("click", () => this.reset());

                // Handle setting changes (will call updateSettings)
                this.studyInput.addEventListener("change", () => {
                    this.updateSettings();
                });
                this.breakInput.addEventListener("change", () => {
                    this.updateSettings();
                });

                // Get preset buttons and assign listeners
                const presetButtons = document.querySelectorAll(".preset-btn");
                presetButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const [study, breakTime] = e.target.textContent.split('-').map(Number);
                        this.setPreset(study, breakTime);
                    });
                });

                // Handle notification close buttons
                document.getElementById('closeBreakNotificationBtn').addEventListener('click', () => {
                    this.closeBreakNotification();
                });

                // Handle break cap notification close button
                document.getElementById('closeBreakCapBtn').addEventListener('click', () => {
                    this.closeBreakCapNotification();
                });

                // Handle XP notification close button
                document.getElementById('closeXpBtn').addEventListener('click', () => {
                    this.closeXpNotification();
                });

                // Handle back button
                this.backBtn.addEventListener('click', () => {
                    window.location.href = 'dashboard.html';
                });
            }
            
            // --- NEW/UPDATED LOGIC ---

            // Method to enable/disable input fields and preset buttons
            toggleSettings(enable) {
                this.studyInput.disabled = !enable;
                this.breakInput.disabled = !enable;
                
                // Also disable preset buttons
                document.querySelectorAll(".preset-btn").forEach(btn => {
                    btn.disabled = !enable;
                });
            }

            setPreset(studyMinutes, breakMinutes) {
                if (this.isRunning || this.isPaused) return; 
                this.closeBreakCapNotification();
                this.studyInput.value = studyMinutes;
                this.breakInput.value = breakMinutes;
                this.reset();
            }

            start() {
                if (!this.isRunning) {
                    this.isRunning = true;
                    this.isPaused = false;
                    this.startBtn.style.display = "none";
                    this.pauseBtn.style.display = "inline-block";
                    this.toggleSettings(false); // DISABLE settings on start

                    this.interval = setInterval(() => {
                        this.timeLeft--;
                        this.updateDisplay();

                        if (this.timeLeft <= 0) {
                            this.completeTimer();
                        }
                    }, 1000);
                }
            }

            pause() {
                if (this.isRunning) {
                    this.isRunning = false;
                    this.isPaused = true;
                    clearInterval(this.interval);
                    this.startBtn.style.display = "inline-block";
                    this.pauseBtn.style.display = "none";
                    // Settings remain disabled while paused
                }
            }

            reset() {
                this.isRunning = false;
                this.isPaused = false;
                clearInterval(this.interval);
                this.isStudyMode = true; // Always reset to study mode
                this.updateSettings(true); // Recalculate and reset timeLeft
                this.startBtn.style.display = "inline-block";
                this.pauseBtn.style.display = "none";
                this.closeBreakNotification(); // Hide notification on manual reset
                this.closeBreakCapNotification(); // Hide cap notification on manual reset
                this.toggleSettings(true); // ENABLE settings on reset
            }

            async completeTimer() {
                clearInterval(this.interval);
                this.isRunning = false;
                this.isPaused = false;

                this.playNotification();

                // Switch mode
                this.isStudyMode = !this.isStudyMode;
                
                if (!this.isStudyMode) {
                    // Just finished study, now start break
                    this.studyCount++;
                    await this.updateUserStats();
                    await this.awardXP(25, 'Completed Pomodoro Session');
                    this.updateSettings(true); 
                    this.showBreakNotification();
                } else {
                    // Just finished break, now start study
                    this.breakCount++;
                    await this.updateUserStats();
                    alert("Break time is over! Time to study! ðŸŽ“");
                    this.updateSettings(true); 
                }
                
                this.updateDisplay();
                this.updateStats();

                // Auto-start the new phase (which will disable settings again)
                this.start();

                this.startBtn.style.display = "none";
                this.pauseBtn.style.display = "inline-block";
            }

            async updateUserStats() {
                if (!this.currentUser) return;

                const studyMinutes = parseInt(this.studyInput.value) || 25;
                const breakMinutes = parseInt(this.breakInput.value) || 5;
                
                const updateData = {
                    studySessions: this.studyCount,
                    totalStudyTime: this.studyCount * studyMinutes,
                    totalBreakTime: this.breakCount * breakMinutes,
                    lastActive: new Date()
                };

                await updateUserData(this.currentUser.uid, updateData);
            }

            showBreakNotification() {
                this.breakNotification.style.display = "block";
            }
            
            closeBreakNotification() {
                this.breakNotification.style.display = "none";
            }

            showBreakCapNotification() {
                this.breakCapNotification.style.display = "block";
            }
            
            closeBreakCapNotification() {
                this.breakCapNotification.style.display = "none";
            }

            showXpNotification(xpAmount, reason, isLevelUp = false) {
                this.xpAmount.textContent = `+${xpAmount} XP`;
                this.xpReason.textContent = reason;
                
                if (isLevelUp) {
                    this.xpNotification.classList.add('level-up-notification');
                    this.xpNotification.querySelector('h3').innerHTML = '<i class="fas fa-trophy"></i> Level Up!';
                } else {
                    this.xpNotification.classList.remove('level-up-notification');
                    this.xpNotification.querySelector('h3').innerHTML = '<i class="fas fa-star"></i> Focus Points Earned!';
                }
                
                this.xpNotification.style.display = "block";
            }
            
            closeXpNotification() {
                this.xpNotification.style.display = "none";
            }

            async awardXP(xpAmount, reason) {
                if (!this.currentUser) return;

                const result = await addXP(this.currentUser.uid, xpAmount, reason);
                if (result.success) {
                    this.showXpNotification(xpAmount, reason, result.leveledUp);
                    
                    if (result.leveledUp) {
                        // Update user data after level up
                        await this.loadUserData();
                    }
                }
            }

            updateSettings(forceResetTime = false) {
                // Prevent settings change mid-session, unless called by reset/completeTimer
                if (!forceResetTime && (this.isRunning || this.isPaused)) return; 

                let studyMinutes = parseInt(this.studyInput.value) || 25;
                let breakMinutes = parseInt(this.breakInput.value) || 5;
                let capWasEnforced = false; 
                
                // NEW RULE: Break time must be strictly less than Study time
                // Max allowed break is one minute less than study time, minimum 1.
                const maxAllowedBreak = Math.max(1, studyMinutes - 1); 
                
                // Check if break time is greater than or EQUAL to study time.
                if (breakMinutes >= studyMinutes) {
                    capWasEnforced = true;
                    breakMinutes = maxAllowedBreak;
                    this.breakInput.value = breakMinutes; // Update input field
                }

                if (capWasEnforced) {
                    this.cappedBreakTimeDisplay.textContent = breakMinutes;
                    this.showBreakCapNotification();
                } else {
                    // Ensure the cap notification is hidden if the input is valid
                    this.closeBreakCapNotification();
                }

                if (this.isStudyMode) {
                    this.totalTime = studyMinutes * 60;
                    if (forceResetTime || !this.isRunning) {
                        this.timeLeft = studyMinutes * 60;
                    }
                } else {
                    this.totalTime = breakMinutes * 60;
                    if (forceResetTime || !this.isRunning) {
                        this.timeLeft = breakMinutes * 60;
                    }
                }
                
                if (forceResetTime || !this.isRunning) {
                    this.updateDisplay();
                }
            }
            // --- END NEW/UPDATED LOGIC ---

            updateDisplay() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                const progress = 100 - (this.timeLeft / this.totalTime) * 100;

                this.timerDisplay.textContent = `${minutes
                    .toString()
                    .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

                document.title = `${this.isStudyMode ? 'Study' : 'Break'} (${this.timerDisplay ? this.timerDisplay.textContent : ''}) - FocusFlow`;

                if (this.isStudyMode) {
                    this.modeDisplay.textContent = "Study Time";
                    this.modeDisplay.className = "mode-display study-mode";
                } else {
                    this.modeDisplay.textContent = "Break Time";
                    this.modeDisplay.className = "mode-display break-mode";
                }

                if (this.progressFill) this.progressFill.style.width = `${progress}%`;
            }

            updateStats() {
                // Update total time spent (in minutes)
                this.totalTimeSpent = this.studyCount + this.breakCount;
                
                // Calculate productivity (study sessions / total sessions)
                const totalSessions = this.studyCount + this.breakCount;
                const productivity = totalSessions > 0 ? Math.round((this.studyCount / totalSessions) * 100) : 0;
                
                this.studyCountElement.textContent = this.studyCount;
                this.breakCountElement.textContent = this.breakCount;
                if (this.totalTimeElement) this.totalTimeElement.textContent = `${this.totalTimeSpent} min`;
                if (this.productivityElement) this.productivityElement.textContent = `${productivity}%`;
            }

            playNotification() {
                // Creates a quick beep using Web Audio API
                const audioContext = new (window.AudioContext ||
                    window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(
                    600,
                    audioContext.currentTime + 0.1
                );

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(
                    0.01,
                    audioContext.currentTime + 0.3
                );

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            }
        }

        // --- Global Setup ---
        const timer = new PomodoroTimer();

        function setPreset(studyMinutes, breakMinutes) {
            timer.setPreset(studyMinutes, breakMinutes);
        }

        document.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>